# v1.5.5 Fixes

Pwnagotchi v1.5.5 has a number of gotchas that need to be patched in order for it to work properly. See release [here](https://github.com/evilsocket/pwnagotchi/releases/tag/v1.5.5).

## Support Waveshare V3 Display


[Amazon Link](https://a.co/d/2lTqyDy)

The current iteration of Waveshare displays is version 3, which is not compatible out of the gate with v1.5.5. V3 support has been added to the project but has not yet made its way into a release, so to backfill support in v1.5.5 you can copy the changes from [this PR](https://github.com/evilsocket/pwnagotchi/commit/91e95cede0b17aeb1a09f13930869baa245a5616) directly into the pwnagotchi python package.

You can find where the package is located by running `pip3 show pwnagotchi`, which should show that the package is installed at `/usr/lib/python3/dist-package/pwnagotchi`. So, switch into that directory and update all of the files. You could try copying the new files over, but for some reason that didn't work for me but copying just the changes from this PR did work.

Once the changes are copied over, update `/etc/pwnagotchi/config.toml` to include `ui.display.type = "waveshare_3"` and then restart the service `systemctl restart pwnagotchi` and the display should now work.

## Support UPS Lite v1.3

https://www.tindie.com/products/rachel/ups-lite-for-raspberry-pi-zero/
https://github.com/linshuqin329/UPS-Lite/blob/master/UPS-Lite_V1.3_CW2015/Instructions%20for%20UPS-Lite%20V1.3.pdf

### Reading Data

Out of the box the `ups_lite` plugin doesn't support UPS Lite v1.3. Specifically because v1.3 has a different I2C address. We can fix this by updating the address in `/usr/local/lib/python3.7/dist-packages/pwnagotchi/plugins/default/ups_lite.py`. Specifically, make sure to read from `CW2015_ADDRESS  = 0x62` for both voltage and capacity, and for the voltage reading the calculation should be `return swapped * 0.305 / 1000`. It may not be necesarry, but in the `__init__` you should also wake up the CW2015 chip by calling `self._bus.write_word_data(CW2015_ADDRESS, CW2015_REG_MODE, 0x30)` where `CW2015_REG_MODE = 0x0a`. 

### Charging Indicator

You can also add `GPIO.setwarnings(False)` before checking if charging to ensure no GPIO warnings are logged. If you plan on using the charge indicator you must bridge the two split pads on the back side of the board.

### Caution

Make sure not to enable `main.plugins.ups_lite.shutdown` until you are certain that the capacity is being read correctly. Otherwise the board will shut itself down as soon as the UPS Lite plugin loads.

## Add DS3231 RTC

By default the RPi time will be incorrect and so will the time on the logs. We can fix this by soldering on a DS3231 RTC over I2C. Once the RTC is soldered on we need to tell the RPi to use the RTC as its clock. Follow [this Adafruit guide](https://learn.adafruit.com/adding-a-real-time-clock-to-raspberry-pi/set-rtc-time) in order to enable the hardware clock on the RPi. Once that is done we still need to set the actual time on the RPi. 

By default your RPi won't have internet access, so we will need to set the time manually.

On your computer, open a web browser and open the console and type the following:

```js
function getTime(shift = 0) {
    const currentDate = new Date();
    const iso = currentDate.toISOString();
    const timeParts = iso.split('.');
    const firstPart = timeParts[0];
    const originalSeconds = firstPart.slice(firstPart.length - 2);
    const adjustedSeconds = Number(originalSeconds) + shift;
    const fixedFirstPart = firstPart.slice(0, firstPart.length - 2) + adjustedSeconds;
    const fixedTime = fixedFirstPart + '.' + timeParts[1];
    const ele = document.createElement("input");
    ele.value = fixedTime;
    document.body.appendChild(ele);
    ele.select();
    document.execCommand("copy");
    document.body.removeChild(ele);
    return fixedTime;
}

getTime(5);
```

This will get the current time (plus 5 seconds) as an ISO timestamp and copy it to your clipboard. While SSH into the pwnagotchi, after 5 seconds type the following, pasting the ISO timestamp in:

```bash
sudo date -s "{your copied timestamp}"
```

If you time it correctly you should now have the correct time displayed on your RPi when you run the `date` command. Set this time to the RTC by running `sudo hwclock -w`.

As a final step, make sure that you set the timezone on your pi so that it shows the correct time based off of the UTC time you just set. Run `sudo raspi-config` and go to `Localisation Options` and set the `Timezone`.

## Fix the AI

Apparently v1.5.5 was shipped with broken AI. When you start the device it should start in `Auto` mode (aka dumb mode) and run a default attack sequence while it is waiting for the A2C model to load. It should load after about 10 minutes and then switch from `Auto` to `AI` mode. However, if it never switches into `AI` mode it's probably because the model can't be loaded. Fixing this is fairly involved. First, `cat /var/log/pwnagotchi.log` and look for errors. If you see something like the following then you should try this fix:

```bash
[ERROR] error while starting AI (numpy.ndarray size changed, may indicate binary incompatibility. Expected 44 from C header, got 40 from PyObject)
```

Basically the version of `numpy` that was shipped is incompatible with the base model and we need to upgrade numpy. You can read about it [here](https://github.com/evilsocket/pwnagotchi/issues/992). In order to update `numpy` we first need to enable internet on the RPi.

### Enable Internet

With the device plugged into your computer via its data port (the inside micro port) we can share our computer's internet by running the share script;

```bash
sudo ./scripts/macos_connection_share.sh
```

You ought to see something like this:

```bash
sharing connecting from upstream interface en0 to usb interface en8 ...
net.inet.ip.forwarding: 0 -> 1
No ALTQ support in kernel
ALTQ related functions disabled
pf enabled
pfctl: Use of -f option, could result in flushing of rules
present in the main ruleset added by the system at startup.
See /etc/pf.conf for further details.

No ALTQ support in kernel
ALTQ related functions disabled
```

Make sure you don't have a VPN enabled. While SSH into the RPi try `ping google.com` and it still won't work even if the internet sharing is setup correctly. We need to update the name server.

```bash
sudo nano /etc/resolv.conf
```

and change the nameserver to `8.8.8.8`. Note that this will reset on boot, so you will need to update this each time you need to share the internet. Try pinging google again and you should now get packets back. Hooray.

### Increase Swapfile

Downloading `numpy` will require is to compile on the RPi which will take a very long time. In order not to go insane we need to bump the swapfile so that the Pi has more memory. The process outlined below comes from [here](https://nebl.io/neblio-university/enabling-increasing-raspberry-pi-swap/).

1. Stop the swap: `sudo dphys-swapfile swapoff`
2. Change the `CONF_SWAPSIZE` from `CONF_SWAPSIZE=100` to `CONF_SWAPSIZE=1024` in `sudo nano /etc/dphys-swapfile`
3. Initialize the swapfile with `sudo dphys-swapfile setup`
4. Start the swap with `sudo dphys-swapfile swapon`

After building `numpy` go back and set the swap back to 100.

### Upgrade numpy

Now that we have internet and have increased the swapsize we can finally upgrade numpy. This will take a very long time, so make sure to install it using `--verbose` so that we can monitor the progress.

1. SSH into the pi
2. Start a screen session so that if we get disconnected for some reason we can get back into it: `screen bash` (to exit, ctrl-a and then d. To rejoin `screen -r`. To kill the session ctrl-d)
3. Start the install: `sudo pip3 install --verbose --upgrade numpy --no-cache-dir`
4. Once it successfully installs, go back and reset the swap size

You should be good to go now!
Restart the service and boot it into Auto mode and watch the logs and you should see that the AI model now loads after about 10 minutes: `sudo touch /root/.pwnagotchi-auto && systemctl restart pwnagotchi && tail -f /var/log/pwnagotchi.log`

## Add a Shutdown Button

Solder a 6mm pushbutton to between pin GPIO20 and GND (the spacing works perfectly).

Then add the following to your config:

```bash
main.plugins.gpio_shutdown.enabled = true
main.plugins.gpio_shutdown.gpio = 20
```

## Add Haptic Feedback

Get some [mini vibration motors](https://www.amazon.com/gp/product/B071WYG59X) to add haptic feedback. Build [this circuit](https://learn.adafruit.com/adafruit-arduino-lesson-13-dc-motors).

Checkout [the plugin](./pwnagotchi/plugins/custom/haptic.py) and then set in the config:

```bash
main.plugins.haptic.enabled = true
main.plugins.haptic.gpio = 23
```
